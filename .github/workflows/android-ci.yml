name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      
    - name: Setup JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-disabled: true
        gradle-home-cache-cleanup: true
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Force clean build (delete all caches)
      run: |
        echo "Deleting build artifacts and caches..."
        rm -rf app/build/
        rm -rf build/
        rm -rf ~/.gradle/caches/
        rm -rf .gradle/
        echo "âœ“ All build artifacts deleted - forcing complete rebuild"
      
    - name: Clean build
      run: ./gradlew clean --no-daemon --warning-mode=all
      
    - name: Build debug APK (will install on any device)
      run: ./gradlew assembleDebug --no-daemon --stacktrace --info --continue --warning-mode=all 2>&1 | tee build-log.txt
      env:
        GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx6144m -XX:MaxMetaspaceSize=1536m -XX:+HeapDumpOnOutOfMemoryError"
        ORG_GRADLE_PROJECT_kotlin.compiler.execution.strategy: "in-process"
    
    - name: Extract errors from build log
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" > errors-only.txt
        echo "COMPILATION ERRORS - $(date)" >> errors-only.txt
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> errors-only.txt
        echo "" >> errors-only.txt
        grep -E "^e: |^w: |error:|warning:|Error|Exception|FAILURE|failed" build-log.txt >> errors-only.txt 2>&1 || echo "No errors found (build succeeded)" >> errors-only.txt
        echo "" >> errors-only.txt
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> errors-only.txt
        cat errors-only.txt
    
    - name: Create crash log instructions
      if: always()
      run: |
        cat > CRASH_LOG_INSTRUCTIONS.txt << 'EOF'
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ðŸ“± HOW TO GET CRASH LOGS FROM YOUR PHONE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        This APK includes BUILT-IN CRASH LOGGING!
        
        âš ï¸ IMPORTANT: Crash logs are generated ON YOUR PHONE when the app 
        crashes, not during the build process. Follow these steps:
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        STEP 1: INSTALL THE APK
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        1. Download "quantravision-debug-apks" artifact from GitHub Actions
        2. Extract the ZIP file
        3. Install: app-arm64-v8a-debug.apk (115MB - best for S23 FE)
           OR: app-universal-debug.apk (263MB - works on any device)
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        STEP 2: TRIGGER THE CRASH
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        1. Open QuantraVision app
        2. Use the app normally until it crashes
        3. The crash is automatically saved to internal storage
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        STEP 3: EXPORT THE CRASH LOG
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        1. RESTART the app (after it crashes)
        2. You'll see a simple test screen
        3. Click the RED button: "Share Crash Log"
        4. Choose how to share (Gmail, Drive, Messages, etc.)
        5. Send the crash log file to the developer
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        WHAT THE CRASH LOG CONTAINS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        âœ… Exact error message and stack trace
        âœ… Device info (model, Android version)
        âœ… Memory usage at time of crash
        âœ… Timestamp
        âœ… Thread information
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        TROUBLESHOOTING
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Q: App crashes but no "Share Crash Log" button appears
        A: Make sure you RESTART the app after it crashes. The crash is 
           saved during the crash, but you need to reopen the app to 
           access the export feature.
        
        Q: "No crash logs found" message appears
        A: The app hasn't crashed yet, or crashed before crash logging 
           was implemented. Try using the app again.
        
        Q: Can't share the file
        A: Make sure you have a file sharing app installed (Gmail, Drive, 
           Messages, etc.)
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        TECHNICAL DETAILS (FOR REFERENCE)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Crash log location: /data/data/com.lamontlabs.quantravision/files/
                           quantravision_crash.log
        
        Implementation: Custom UncaughtExceptionHandler that captures 
                       crashes before the app terminates
        
        File sharing: Android FileProvider with internal file storage
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        BUILD INFORMATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Build date: $(date)
        Crash logging: ENABLED
        Version: Minimal test build with crash diagnostics
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EOF
        cat CRASH_LOG_INSTRUCTIONS.txt
    
    - name: Capture build summary
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> build-summary.txt
        echo "Build Summary - $(date)" >> build-summary.txt
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "âš ï¸ CRASH LOGS: See CRASH_LOG_INSTRUCTIONS.txt for how to extract crash logs from your device!" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "APK Files Generated:" >> build-summary.txt
        find app/build/outputs/apk -name "*.apk" -exec ls -lh {} \; >> build-summary.txt 2>&1 || echo "No APK files found" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "APK Details:" >> build-summary.txt
        find app/build/outputs/apk -name "*.apk" | while read apk; do
          echo "  - $(basename $apk): $(du -h "$apk" | cut -f1)" >> build-summary.txt
        done 2>&1 || echo "Could not get APK sizes" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "Build directories:" >> build-summary.txt
        ls -la app/build/outputs/ >> build-summary.txt 2>&1 || echo "No build outputs" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> build-summary.txt
        cat build-summary.txt
      
    - name: Upload Debug APKs (will install on Android 14)
      uses: actions/upload-artifact@v5
      if: success()
      with:
        name: quantravision-debug-apks
        path: |
          app/build/outputs/apk/debug/*.apk
        retention-days: 3
        compression-level: 0
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: build-logs
        path: |
          build-log.txt
          build-summary.txt
          errors-only.txt
          CRASH_LOG_INSTRUCTIONS.txt
        retention-days: 3
