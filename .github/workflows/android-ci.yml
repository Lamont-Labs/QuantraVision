name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v5
      
    - name: Setup JDK 17
      uses: actions/setup-java@v5
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-disabled: true
        gradle-home-cache-cleanup: true
        
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Force clean build (delete all caches)
      run: |
        echo "Deleting build artifacts and caches..."
        rm -rf app/build/
        rm -rf build/
        rm -rf ~/.gradle/caches/
        rm -rf .gradle/
        echo "✓ All build artifacts deleted - forcing complete rebuild"
      
    - name: Clean build
      run: ./gradlew clean --no-daemon --warning-mode=all
      
    - name: Build release APK
      run: ./gradlew assembleRelease --no-daemon --stacktrace --warning-mode=all 2>&1 | tee build-log.txt
      env:
        GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:MaxMetaspaceSize=512m"
    
    - name: Capture build summary
      if: always()
      run: |
        echo "════════════════════════════════════════" >> build-summary.txt
        echo "Build Summary - $(date)" >> build-summary.txt
        echo "════════════════════════════════════════" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "APK Files Generated:" >> build-summary.txt
        find app/build/outputs/apk -name "*.apk" -exec ls -lh {} \; >> build-summary.txt 2>&1 || echo "No APK files found" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "APK Details:" >> build-summary.txt
        find app/build/outputs/apk -name "*.apk" | while read apk; do
          echo "  - $(basename $apk): $(du -h "$apk" | cut -f1)" >> build-summary.txt
        done 2>&1 || echo "Could not get APK sizes" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "Build directories:" >> build-summary.txt
        ls -la app/build/outputs/ >> build-summary.txt 2>&1 || echo "No build outputs" >> build-summary.txt
        echo "" >> build-summary.txt
        echo "════════════════════════════════════════" >> build-summary.txt
        cat build-summary.txt
      
    - name: Upload Release APKs (all architectures)
      uses: actions/upload-artifact@v5
      if: success()
      with:
        name: quantravision-release-apks
        path: |
          app/build/outputs/apk/release/*.apk
        retention-days: 30
    
    - name: Upload Build Logs
      uses: actions/upload-artifact@v5
      if: always()
      with:
        name: build-logs
        path: |
          build-log.txt
          build-summary.txt
        retention-days: 30
